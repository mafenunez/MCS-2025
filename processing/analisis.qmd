---
title: "Justicia de mercado en la eduación: un estudio de las preferencias distributivas en Chile"
author: María Fernanda Núñez y Tomás Urzúa
bibliography: "../input/bib/bib-metodos.bib"
format: pdf
editor: visual
lang: es
---

```{r}
#| echo: false
#| label: data
pacman::p_load(tidyverse, sjPlot, summarytools,tidyr,
               dplyr,
               sjPlot,
               sjmisc,
               psych,
               texreg,
               haven,
               ggplot2,
               lmtest,
               DescTools)

options(scipen = 999)

load("../output/proc_data.RData")
```

## Formulación del problema


## Base de datos

Para cumplir con el objetivo propuesto, se utilizará la base de datos de 2023 del Estudio Longitudinal Social de Chile (ELSOC). Este proyecto logra ver la luz gracias al Centro de Estudios de Conflicto y Cohesión Social (COES), siendo un estudio que busca medir las percepciones, preferencias y comportamientos de las y los chilenos en torno a temáticas de conflicto y cohesión social del país. Una de las virtudes de el ELSOC es que proporciona datos panel, es decir, la recopilación de datos anualmente a una muestra representativa de la población durante diez años, lo cual permite aplicar análisis intertemporales. La población objetivo del estudio son hombres y mujeres entre 18 y 75 años, residentes de viviendas particulares en zonas urbanas. El procedimiento muestral es probabilístico, estratificado, por conglomerados y multietápico.

Las variables de este trabajo se hallan contenidas dentro de tres módulos: Módulo de Legitimidad y desigualdad social (d), Módulo de territorio (t) y Módulo de Caracterización Sociodemográfica (m). Esta selección busca medir la relación entre la justicia distributiva en educación y variables económicas objetivas, subjetivas, demográficas y percepciones del barrio.

## Variables

El tamaño de la muestra utilizado en este trabajo es de N = 2466, considerando el tratamiendo de los casos perdidos de las variables de interés en el marco de la ola correspondiente al año 2023.

### Variable dependiente

```{r}
#| echo: false
proc_data %>%
  count(just_educacion) %>% rename("Preferencia por justicia de mercado en la educación" = just_educacion) %>%
  mutate("%" = round(n / sum(n) * 100, 1)) %>%
  knitr::kable(caption = "Frecuencia Preferencia de justicia de mercado en la educación")
```

Esta variable ordinal busca medir el grado de acuerdo de una persona sobre la sentencia "Es justo que las personas de altos ingresos tengan una mejor educación para sus hijos que las personas con ingresos más bajos". La escala de acuerdo contiene cinco categorías de respuesta, las cuales van desde "Totalmente en desacuerdo" (1) hasta "Totalmente de acuerdo" (5). Se realizo el tratamiento de NA...

### Variables independientes

```{r}
#| echo: false

proc_data %>%
  select("Ingreso Total del hogar" = ingreso_hogar,"Estatus Social Subjetivo" = estatus_subj) %>%  summary() %>%  knitr::kable(caption = "Descriptivos variables cuantitativas")

```

Ingreso total (m29): La variable busca medir cuánto fue el ingreso total del hogar del entrevistado durante el último mes, considerando los ingresos líquidos de todos los miembros del hogar. El fraseo de la pregunta es "En el mes pasado, ¿cuál fue el ingreso total de su hogar? (Considere los ingresos líquidos de los miembros del hogar, es decir, después de descuentos de impuestos, salud, previsión u otros)". Posee respuesta numérica abierta

Estatus social subjetivo (d01_01): Variable de tipo ordinal que busca saber en qué posición social se ubica el encuestado. El fraseo de la pregunta dice "En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad. Usando la escala presentada, donde 0 es el nivel más bajo y 10 el nivel más alto, ¿Dónde se ubicaría usted en la sociedad chilena?". Como se lee en el fraseo, la variable posee once categorías de respuesta, donde mientras más alto el número, más alto se posiciona socialmente la persona desde su autopercepción.

```{r}
#| echo: false
proc_data %>%
  count(genero) %>% rename("Género" = genero) %>%
  mutate("%" = round(n / sum(n) * 100, 1)) %>%
  knitr::kable(caption = "Frecuencia Género")
```

Variable de carácter nominal que busca saber el sexo del encuestado. Hombre tiene la categoría de respuesta 1, mientras que Mujer la 2.

```{r}
#| echo: false
proc_data %>%
  count(esfuerzo) %>% rename("Esfuerzo" = esfuerzo) %>%
  mutate("%" = round(n / sum(n) * 100, 1)) %>%
  knitr::kable(caption = "Percepción de esfuerzo en la sociedad")
```

Variable de tipo ordinal que pretende medir el grado de acuerdo respecto a la frase "En Chile, las personas son recompensadas por sus esfuerzos". Contiene cinco categorías de respuesta, las cuales van desde "Totalmente en desacuerdo" (1) hasta "Totalmente de acuerdo" (5).


```{r}
#| echo: false
proc_data %>%
  count(talento) %>% rename("Talento" = talento) %>%
  mutate("%" = round(n / sum(n) * 100, 1)) %>%
  knitr::kable(caption = "Percepción de talento en la sociedad")
```

Variable de tipo ordinal que pretende medir el grado de acuerdo respecto a la frase "En Chile, las personas son recompensadas por su inteligencia y habilidad". Contiene cinco categorías de respuesta, las cuales van desde "Totalmente en desacuerdo" (1) hasta "Totalmente de acuerdo" (5).

## Correlaciones

Dado que las variables de interés son ordinales, cuantitativas y dicotomicas, es que se aplicarán correlaciones policóricas, de pearson y una tabla de contingencia según corresponda para estimar su asociación.

### Matriz de correlaciones general

```{r}
#| echo: false
matriz <- proc_data %>% mutate_all(~(as.numeric(.))) 

sjPlot::tab_corr(matriz, 
                 triangle = "lower")
```

En general, podemos....


Ahora, veremos como se relaciona cada variable predictoras con las preferencias por justicia de mercado en la eduación de acuerdo a sus niveles de medición. 


### a. Tabla de contingencia: Justicia de mercado en la educación y género

```{r}
#| echo: false
#| warning: false


tabla <- prop.table(table(proc_data$just_educacion, proc_data$genero))*100

tabla_df <- as.data.frame.matrix(tabla)

tabla_df <- tibble::rownames_to_column(tabla_df, var = "Preferencias")


kableExtra::kbl(tabla_df, caption = "Tabla de Contingencia: Género por Preferencia", booktabs = TRUE, align = "c") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10) %>%
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::add_header_above(c(" " = 1, "Género" = 2))


```

```{r}
#| echo: false
#| results: hide

chi_results <- chisq.test(table(proc_data$just_educacion, proc_data$genero))

tabla <- table(proc_data$just_educacion, proc_data$genero)
#calcular v de cramer 
chi2 <- chi_results$statistic
n <- sum(tabla)
k <- min(dim(tabla))
v_cramer <- sqrt(chi2 / (n * (k - 1)))
```

La tabla de contingencia nos muestra que las mujeres tienden a estar más en desacuerdo (33% en desacuerdo y 17% muy en desacuerdo) con preferir la justicia de mercado en la eduación que los hombres. En esta asociación, el chi cuadrado es significativo (p-value = 0.002) y presenta un tamaño efecto bajo (V de Cramer =0.07).

### b. Correlación Policórica: Justicia de mercado en la educación y percepciones de meritocracia

```{r}
#| echo: false
#| warning: false

matriz <- proc_data %>% select(just_educacion, esfuerzo, talento) %>% mutate_all(~(as.numeric(.)))  

cor_matrix <- psych::polychoric(matriz, na.rm = T)

tabla <- round(cor_matrix$rho, 2)

kableExtra::kbl(tabla, caption = "Preferencias por justicia de mercado en la educación y percepciones de meritocracia", booktabs = TRUE, align = "c") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10) 

#%>%
 #kableExtra::column_spec(1, bold = TRUE) %>%
  #kableExtra::add_header_above(c(" " = 1, "Cercanía escuelas" = 2))


```

```{r}
#| echo: false
#| results: hide
#| warning: false


cor.test(matriz$just_educacion, matriz$esfuerzo, method = "spearman")

0.15^2*100

cor.test(matriz$just_educacion, matriz$talento, method = "spearman")

0.13^2*100
```

La correlación policorica indica un relación --, de modo que a mayor preferencia por justicia de mercado mayor ---. Esta relación  es significativa (p-value = ) y comparten el -- varianza.

La correlación policorica indica un relación --, de modo que a mayor preferencia por justicia de mercado mayor ---. Esta relación  es significativa (p-value = ) y comparten el -- varianza.

### c. Correlaciones de Pearson: Justicia de mercado en la educación y estatus social subjetivo e ingreso total de los hogares

```{r}
#| echo: false
matriz <- proc_data %>% select(just_educacion, ingreso_hogar, estatus_subj) %>% mutate_all(~(as.numeric(.))) 

sjPlot::tab_corr(matriz, 
                 triangle = "lower")
```

```{r}
#| echo: false
#| results: hide

p <- proc_data %>% select(just_educacion, estatus_subj) %>% mutate_all(~(as.numeric(.)))  

cor.test(p$just_educacion, p$estatus_subj, method = "pearson")

0.0007^2*100
```

La correlación de Pearson indica un relación baja y positiva, de modo que a mayor preferencia por justicia de mercado perciben tener un mayor estatus en la sociedad chilena. Sin embargo esta relación no es significativa (p-value = 0.9) y comparten muy baja varianza (0.000049%).


```{r}
#| echo: false
#| results: hide

p <- proc_data %>% select(just_educacion, ingreso_hogar) %>% mutate_all(~(as.numeric(.))) 

cor.test(p$just_educacion, p$ingreso_hogar, method = "pearson")

0.02^2

0.0004*100
```

La correlación de Pearson indica un relación baja y positiva, de modo que a mayor preferencia por justicia de mercado presentan un mayor monto total a nivel de su hogar. Sin embargo esta relación no es significativa (p-value = 0.1) y comparten muy baja varianza (0.04%).



## Regresión lineal


### Variable dependiente

```{r}
#| echo: false
plot_stackfrq(proc_data[, "just_educacion"]) + theme(legend.position="bottom") + labs(title = "Preferencias por justicia a la educación")
```


```{r}
#| echo: false
proc_data_lm <- proc_data %>% mutate_all(~(as.numeric(.))) 
```

### Modelos simples
```{r}
#| echo: false
fit01<- lm(just_educacion~genero,data=proc_data_lm)
fit02<- lm(just_educacion~ingreso_hogar,data=proc_data_lm)
fit03<- lm(just_educacion~estatus_subj,data=proc_data_lm)
fit04<- lm(just_educacion~esfuerzo,data=proc_data_lm)
fit05<- lm(just_educacion~talento,data=proc_data_lm)
```

```{r}
#| echo: false
labs01 <- c("Intercepto","Género",
            "Ingreso Total Hogar","Estatus Social Subjetivo","Cercanía Escuelas")
```

```{r}
#| echo: false
#| results: asis

texreg::texreg(list(fit01,fit02,fit03,fit04),custom.coef.names = labs01)
```


### Valores predichos: género

```{r}
#| echo: false
#| results: asis

texreg::texreg(list(fit01), 
       custom.model.names = c("Modelo 1"),
        custom.coef.names = c("Intercepto",
                              "Género (mujer=1)"))
```

```{r}
#|echo: false

pred <- ggeffects::ggpredict(fit01, terms = c("genero"))
print(names(pred))

ggeffects::ggpredict(fit01, terms = c("genero")) %>%
  ggplot(aes(x=x, y=predicted)) +
  geom_bar(stat="identity", color="grey", fill="grey")+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width=.1) +
  labs(title="Género", x = "", y = "") +
  theme_bw() +
  scale_x_continuous(name = "",
                     breaks = c(0,1),
                     labels = c("Hombre", "Mujer"))+
  scale_y_continuous(limits = c(0,16), 
                     breaks = seq(0,16, by = 1))
```

### Valores predichos: ingreso
```{r}
#| echo: false

#valores predichos variable cuanti 
ggeffects::ggpredict(fit02, terms="ingreso_hogar") %>%
  ggplot(mapping=aes(x = x, y=predicted)) +
  labs(title="Ingreso Hogar", x = "", y = "")+
  theme_bw() +
 geom_smooth()+
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2, fill = "black") +
  scale_x_continuous(breaks = seq(0,100, by = 10))+
  scale_y_continuous(limits = c(0,16), 
                     breaks = seq(0,16, by = 1))
```

### Modelos multivariados

```{r}
#| echo: false
#| results: asis
fit06<- lm(just_educacion~genero+ingreso_hogar,data=proc_data_lm)
fit07<- lm(just_educacion~genero+ingreso_hogar+estatus_subj,data=proc_data_lm)
fit08<- lm(just_educacion~genero+ingreso_hogar+estatus_subj + esfuerzo,data=proc_data_lm)
fit09<- lm(just_educacion~genero+ingreso_hogar+estatus_subj + esfuerzo + talento,data=proc_data_lm)

texreg::texreg(list(fit06,fit07,fit08, fit09),
        custom.model.names = c("Modelo 1","Modelo 2","Modelo 3", "Modelo 4"))
```




### Efectos de interacción


```{r}
#| echo: false
fit10<- lm(just_educacion~genero+ingreso_hogar+estatus_subj+esfuerzo*talento,data=proc_data_lm)
sjPlot::tab_model(fit09,fit10, show.ci = FALSE)

```

```{r}
#| echo: false
sjPlot::plot_model(fit10, type = "int") +
  theme_bw() +
  theme(legend.position = "bottom")
```


## Regresión logística


### Variable dependiente

```{r}
#| echo: false

proc_data <- proc_data %>%
  mutate(just_educacion_recod = car::recode(just_educacion,
    "'Totalmente en desacuerdo' = 'En desacuerdo';
     'Totalmente de acuerdo' = 'De acuerdo';
     'Ni de acuerdo ni en desacuerdo' = NA"
  )) 

proc_data <- proc_data %>%
  mutate(just_educacion_recod = case_when(
    just_educacion_recod == "En desacuerdo" ~ 0,
    just_educacion_recod == "De acuerdo" ~ 1,
    TRUE ~ NA_real_
  ))

proc_data <- proc_data %>%
  mutate(just_educacion_recod = labelled(just_educacion_recod, labels = c("En desacuerdo" = 0, "De acuerdo" = 1)))

proc_data$just_educacion_recod <- as.factor(proc_data$just_educacion_recod)

```
Con la recodificación se pierden 228 casos correspondientes a la cateogría "Ni de acuerdo ni en desacuerdo"...

```{r}
#| echo: false

sjPlot::plot_stackfrq(proc_data$just_educacion_recod) +
  theme(legend.position = "bottom") +
  labs(title = "Preferencias por justicia a la educación dicotómica")

```

### Modelos simples

```{r}
#| echo: false
#proc_data <- proc_data %>% mutate_all(~(as.numeric(.))) 
```

```{r}
#| echo: false
m01<- glm(just_educacion_recod~genero,data=proc_data, family = "binomial"(link = "logit"))
m02<- glm(just_educacion_recod~ingreso_hogar,data=proc_data, family = "binomial"(link = "logit"))
m03<- glm(just_educacion_recod~estatus_subj,data=proc_data, family = "binomial"(link = "logit"))
m04<- glm(just_educacion_recod~esfuerzo,data=proc_data, family = "binomial"(link = "logit"))
m05<- glm(just_educacion_recod~talento,data=proc_data, family = "binomial"(link = "logit"))
```


### Modelos multivariados

```{r}
#| echo: false
#| results: asis

m1log <- glm(just_educacion_recod~ genero + ingreso_hogar, data = proc_data, family = "binomial"(link = "logit"))
m2log <- glm(just_educacion_recod~ genero + ingreso_hogar + estatus_subj, data = proc_data,family = "binomial")
m3log <- glm(just_educacion_recod~ genero + ingreso_hogar + estatus_subj + esfuerzo, data = proc_data, family = "binomial")
m4log <- glm(just_educacion_recod~ genero + ingreso_hogar + estatus_subj + esfuerzo + talento, data = proc_data, family = "binomial")

texreg::texreg(list(m1log,m2log,m3log,m4log),
          custom.model.names = c("M1 (log odds)","M2 (log odds)","M3 (log odds)", "M3 (log odds)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "†")

```

### Estimación de odds ratios

```{r}
#| echo: false
#| results: asis

### Cálculo de OR para cada modelo
m1log_OR <- exp(coef(m1log))
m2log_OR <- exp(coef(m2log))
m3log_OR <- exp(coef(m3log))
m4log_OR <- exp(coef(m4log))

##Odds ratios en tabla de texreg::texreg
texreg::texreg(list(m1log,m2log,m3log,m4log), 
          override.coef = list(m1log_OR,m2log_OR,m3log_OR,m4log_OR), # Sobreescribir coeficientes
          custom.model.names = c("m1 (OR)","m2 (OR)","m3 (OR)", "m4 (OR)"),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "†")
```


### Probabilidades predichas

```{r}
#| echo: false


```

```{r}
#| echo: false

       
```

### Bondad de ajuste

```{r}
#| echo: false
#| results: asis

#anova

anova(m1log, m2log, test = "Chisq")

#likelihood ratio

lrtest(m1log, m2log)

#pseudo R2

m1log_R2<-DescTools::PseudoR2(m1log)
m2log_R2<-DescTools::PseudoR2(m2log)
m3log_R2<-DescTools::PseudoR2(m3log)

#Misma tabla, en log odds, con Pseudo R2
texreg::texreg(list(m1log,m2log,m3log),
          custom.model.names = c("m1 (log odds)","m2 (log odds)","m3 (log odds)"),
          custom.gof.rows=list("Pseudo R2" = c(m1log_R2, m2log_R2,m3log_R2)),
          digits = 3, 
          stars = c(0.001, 0.01, 0.05, 0.1),symbol = "†")
```

### Efectos de interacción

```{r}
#| echo: false
#| results: asis


```


```{r}
#| echo: false

#grafico de probablidades predichas

```

## Conclusiones
